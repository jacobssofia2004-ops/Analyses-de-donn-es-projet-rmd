---
title: "Projet d'analyse de données - Études sur les volcans méditerranéens"
author: |
  <em>Jacobs Sofia & Bauer Julie<br>
  Master STPE/MV – UCA<br>
  Année académique 2025-2026</em>
date: "<span style='float:right;'>25 septembre 2025</span>"
output: 
  html_document:
    toc: yes
    toc_float:  
      collapsed: false     
      smooth_scroll: true  
      position: right     
    number_sections: yes
    css: styles.css

---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = FALSE)
```

# Introduction 

Dans le monde, on compte plus de **800 millions** de personnes vivant à proximité d’un volcan dont **200 millions à moins de 30 km d’un volcan actif** (CNRS, 2025). La caractérisation de l’aléa volcanique est donc essentielle pour **la sureté des habitants** en territoires volcaniques. Cela passe notamment par la compréhension de lien divers entre un volcan et **le type de dépôts ou l’intensité éruptive** qu’il produit. Notre étude se concentre sur la région méditerranéenne, en particulier sur **deux édifices grecs** et **quatre édifices italiens**, ces deux pays étant particulièrement connues pour leurs volcanismes très actifs et notamment plusieurs éruptions historiques. Les volcans italiens sont **l’Etna (Sicile, Italie), le Vésuve (Naples, sud de l’Italie), Lipari et Vulcano (Iles Eoliennes, Sicile, Italie). Les volcans grecques sont le Santorin et le Nisyros (Iles Dodecanese, Grèce)**. Ici nous ne nous concentrerons que sur **la période 2015 à 2025**.

Nous avons **les données de magnitudes, types de magma, profondeur du magma, le VEI, la classification et le volume estimé de produits** pour chaque édifice volcanique en plus des coordonnées des éruptions pour chaque édifices.
L’objectif est de comprendre si il existe un **lien entre intensité de l’éruption (magnitude) et l’édifice volcanique** afin de déterminer quelle population s’expose à un **risque** plus important. Il sera aussi particulièrement intéressant de regarder le **lien possible entre volcans et type de magma** car le risques lié à un volcan est en partie du au type de matériaux qu’il produit. Ces résultats pourrait également nous permettre de déterminer si **les populations** d’un volcan en particulier s’exposent à un **risque accrue**. Enfin, d’un point de vus purement recherche nous allons nous intéressé au **lien entre édifice et profondeur du magma** car c’est grâce à la détection du magma en profondeur que l’on peut **anticiper une éruption**. Egalement à **la profondeur en fonction du type de magma** mais cela nous permettra, au terme d’une étude pétrologique ultérieure de prédire des **temps de remonté du magma et des durées pré-éruptifs** afin **d’alerter la population** en cas d’éruption imminente si ce lien existe.

# Analyse exploiratoire des données 

## Chargement et préparation des données

```{r}
packages <- c("dplyr", "ggplot2", "tidyr","performance","car","maps","ggspatial","sf", "prettymapr","rnaturalearth","rnaturalearthdata","viridis","see","patchwork","geosphere","reshape2","cowplot","factoextra","FactoMineR","plotly","PerformanceAnalytics","ade4","pheatmap","ggsci","nnet")

installed_packages <- rownames(installed.packages())
to_install <- packages[!(packages %in% installed_packages)]

if (length(to_install) > 0) {
  message("Installation des packages manquants : ", paste(to_install, collapse = ", "))
  install.packages(to_install)
}

invisible(lapply(packages, function(pkg) {
  library(pkg, character.only = TRUE)
  message("→ ", pkg, " chargé avec succès.")
}))

```

```{r}
###library(esquisse)
esquisse::esquisser()###
```



```{r}
df <- read.csv("DataR.csv", sep = ";")#importation des données
str(df)
#modification des types de variables 
df [,c(1,2,8,11,12,13,14)]<- lapply(df[,c(1,2,8,11,12,13,14)], as.factor)
df$Volume <- as.numeric(df$Volume)
summary(df)

var_quali <- df[,c("Depth","Magnitude")]
var_quanti <- df[,c("Volcanoes","Mag.Type", "Region","Country")]
```

```{r}
world <- ne_countries(scale = "medium", returnclass = "sf")

# Tracer la carte
ggplot(data = world) +
  geom_sf(fill = "antiquewhite") +
  geom_point(
    data = df,
    aes(x = Longitude, y = Latitude, color = Volcanoes),
    size = 2, alpha = 0.9
  ) +
  coord_sf(xlim = c(12, 30), ylim = c(35, 42), expand = FALSE) +
  theme_minimal() +
  labs(
    title = "Localisation des volcans en Italie du Sud et en Grèce",
    x = "Longitude",
    y = "Latitude",
    color = "Volcan"
  ) +
  theme(panel.background = element_rect(fill = "lightblue"),
        panel.grid = element_line(color = "white"))



```
```{r}
volcanIt <- df[15:36,]
str(volcanIt)
volcanGr <- df[c(1:13,37:47),]
str(volcanGr)
ggplot(data = world) +
  geom_sf(fill = "antiquewhite") +
  geom_point(
    data = volcanIt,
    aes(x = Longitude, y = Latitude, color = Volcanoes),
    size = 2, alpha = 0.9
  ) +
  coord_sf(xlim = c(12, 19), ylim = c(36.5, 41.5), expand = FALSE) +
  theme_minimal() +
  labs(
    title = "Localisation des volcans en Italie du Sud",
    x = "Longitude",
    y = "Latitude",
    color = "Volcan"
  ) +
  theme(panel.background = element_rect(fill = "lightblue"),
        panel.grid = element_line(color = "white"))

```

```{r}
ggplot(data = world) +
  geom_sf(fill = "antiquewhite") +
  geom_point(
    data = volcanGr,
    aes(x = Longitude, y = Latitude, color = Volcanoes),
    size = 2, alpha = 0.9
  ) +
  coord_sf(xlim = c(19, 30), ylim = c(35.5, 39), expand = FALSE) +
  theme_minimal() +
  labs(
    title = "Localisation des volcans de l'Archipelle des Dodecanese",
    x = "Longitude",
    y = "Latitude",
    color = "Volcan"
  ) +
  theme(panel.background = element_rect(fill = "lightblue"),
        panel.grid = element_line(color = "white"))
```


```{r}

centres <- df %>%
  group_by(Volcanoes) %>%
  summarise(
    Longitude = mean(Longitude, na.rm = TRUE),
    Latitude = mean(Latitude, na.rm = TRUE)
  )
dist_matrix_group <- distm(centres[, c("Longitude", "Latitude")], fun = distHaversine) / 1000
rownames(dist_matrix_group) <- centres$Volcanoes
colnames(dist_matrix_group) <- centres$Volcanoes
```
```{r}
dist_long <- melt(dist_matrix_group)
colnames(dist_long) <- c("Volcano1", "Volcano2", "Distance_km")
ggplot(dist_long, aes(x = Volcano1, y = Volcano2, fill = Distance_km)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "red") +
  geom_text(aes(label = round(Distance_km, 1)), color = "black") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Distances entre groupes de volcans (km)", fill = "Distance (km)")
```


## Calcule des paramètres de dispersions

```{r}
#permet de calculer la variance et la moyenne pour les variables 
calc_variances_by_group <- function(df, group_col = "Group", numeric_vars = NULL) {
  if (is.null(numeric_vars)) {
    numeric_vars <- names(df)[sapply(df, is.numeric)]
  }

  # 1. Calcul global
  global_var <- sapply(df[numeric_vars], var, na.rm = TRUE)
  global_mean <- sapply(df[numeric_vars], mean, na.rm = TRUE)

  global_df <- data.frame(
    Group = "Global",
    Variable = names(global_var),
    Variance = as.numeric(global_var),
    Mean = as.numeric(global_mean),
    stringsAsFactors = FALSE
  )

  # 2. Calcul par groupe
  groups <- unique(df[[group_col]])
  group_list <- lapply(groups, function(g) {
    sub_df <- df[df[[group_col]] == g, numeric_vars, drop = FALSE]
    s_var <- sapply(sub_df, var, na.rm = TRUE)
    s_mean <- sapply(sub_df, mean, na.rm = TRUE)
    data.frame(
      Group = g,
      Variable = names(s_var),
      Variance = as.numeric(s_var),
      Mean = as.numeric(s_mean),
      stringsAsFactors = FALSE
    )
  })
  group_df <- do.call(rbind, group_list)

  # 3. Combiner
  result <- rbind(global_df, group_df)
  rownames(result) <- NULL

  # 4. Supprimer la notation scientifique
  result$Variance <- format(result$Variance, scientific = FALSE, digits = 6)
  result$Mean <- format(result$Mean, scientific = FALSE, digits = 6)

  return(result)
}
calc_variances_by_group(df, group_col = "Volcanoes", numeric_vars = c("Depth", "Magnitude", "Volume"))


```

En moyenne, Lipari génère des magmas qui viennent de plus profond et le Santorin les plus superficiels.
Nisyros est le volcan avec le plus grand volume de produit estimé en moyenne et Vulcano emet le moins sur une même période d'activité.
La magnitude des éruptions est en moyenne plus importante pour Nisyros. Cela est cohérent car la magnitude est directement reliée au volume emis, plus le volume est important plus la magnitude le sera, hors Nisyros à le volume moyen le plus important donc la magnitude moyenne la plus importante. Cependant ce n'est pas Vulcano qui possède la plus faible moyenne des magnitudes mais l'Etna. Cela peut s'expliquer par le faite que l'Etna à plus érupter sur 2015-2025 par rapport à Vulcano pour un volume moyen de débris légèrement inférieur. La moyenne des magnitudes de l'Etna pourra donc être légèrement plus faible que celle de Vulcano.

Les valeurs de variance pour le volume et la magnitude sont ccohérentes par rapport au jeu de donné mais pour la profondeur, celles-ci sont beaucoup trop grande, cela s'explique par la présence d'outlier (7 point de donnée) de valeur beaucoup trop importante ou encore bien trop faibe qui donnent une dispersion des mesures exagérée.

On remarque qur pour le Vésuve nous n'avons qu'une seule éruption. Ainsi, nous ne pouvons pas calsuler de valeurs de dispersion et la profondeurs, la magnitude et le volume moyen seront les valeurs des données de l'éruption.
```{r}
#à quoi ça sert (je ne sais pas), pas vraiment utile 
df_quant <- df[,c("Depth","Magnitude","Volume")]
apply(df_quant,2,sd)
apply(df_quant,2,sd)/apply(df_quant,2,mean)
```
```{r}
library(dplyr)

df %>%
  group_by(Volcanoes) %>%
  summarise(
    mean_mag = mean(Magnitude, na.rm = TRUE),
    sd_mag = sd(Magnitude, na.rm = TRUE),
    min_mag = min(Magnitude, na.rm = TRUE),
    max_mag = max(Magnitude, na.rm = TRUE),
    median_mag = median(Magnitude, na.rm = TRUE)
  )

```
Les volcans grecs porduisent une plus large d'éruption de magnitudes différentes que les volacans Italiens et se sont égalment eux qui produisent les éruptions les plus intenses avec Lipari. Cependant, il n'y pas de grande difference entre les différents paramètres de dispersion des les volcans.

# Graphiques des analyses univariés



## Analyse univariée de la profondeur
```{r}

p<- ggplot(df, aes(x = "", y = Depth)) +
  geom_boxplot(outlier.shape = 16, outlier.color = "red", alpha = 0.7) +  # outliers visibles
  stat_summary(fun = mean, geom = "point", shape = 18, size = 3, color = "blue") + # moyenne.
  scale_fill_viridis(discrete = TRUE, option = "D") +  # palette harmonieuse
  theme_minimal(base_size = 14) +
  scale_y_log10() +
  labs(
    title = "Distribution des profondeurs
    pour l'ensemble des volcans",
    x = "",
    y = "Profondeur (log(km)"
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1),  # rotation labels si nécessaire
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(size = 12)
  )
p1 <- ggplot(df,aes(x=Depth))+
  geom_histogram(binwidth = 0.2, fill="lightyellow", color="black", alpha=0.7)+
  geom_density(color = "red", size = 1) +
  theme_minimal()+
  labs(title="Histogramme de la 
       profondeur des magmas ",
       x="Depth",
       y="")+
  theme(plot.title = element_text(hjust = 0.5, face="bold", size=16))
p+p1+plot_layout(widths = c(1,2.25))
```
Pour l'ensemble des volcans, hormis les 7 outliers visibles en rouge sur le boxplot, la répartition des rpofondeurs sur l'hitogramme est symétique par rapport à une valeur centrale de 10 km. La majorité de nos magmas proviennet donc de chambre localsiée entre 15 et 7 km ce qui reste relativement superficielle.

## Analyse univariée de la magnitude
```{r}
p2<- ggplot(df,aes(x=Magnitude))+
  geom_histogram(binwidth = 0.2, fill="lightgreen", color="black", alpha=0.7)+
  geom_density(color = "red", size = 1) +
  theme_minimal()+
  labs(title="Histogramme de la
       magnitude de éruptions ",
       x="Magnitude",
       y="")+
  theme(plot.title = element_text(hjust = 0.5, face="bold", size=16))
```

```{r}
#séparer les deux populations que l'on observe dans le graphique précédent 
df_forte  <- df[df$Magnitude >= 3, ]
df_faible <- df[df$Magnitude < 3, ] # population forte
```

```{r}
p3 <- ggplot(df, aes(x = "", y = Magnitude)) +
  geom_boxplot(outlier.shape = 16, outlier.color = "red", alpha = 0.7) +  # outliers visibles
  stat_summary(fun = mean, geom = "point", shape = 18, size = 3, color = "blue") + # moyenne
  scale_fill_viridis(discrete = TRUE, option = "D") +  # palette harmonieuse
  theme_minimal(base_size = 14) +
  scale_y_log10() +
  labs(
    title = "Distribution des magnitudes 
    pour l'ensemble des volcans",
    x = "",
    y = "Magnitude"
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1),  # rotation labels si nécessaire
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(size = 12))

p3+p2+plot_layout(widths = c(1,1.5))
```
Le boxplot ne montre pas de valeur abérente. Cependant, l'histogramme des magnitudes montre une réputation bimodale des données. Une première partie des magnitudes se situe en dessous de 3, ce sont les valeurs de magnétudes faibles et une seconde partie se trouve au-dessus de 3 avec des valeurs dites fortes.

```{r}
 p4 <- ggplot(df_forte,aes(x=Magnitude))+
  geom_histogram(binwidth = 0.2, fill="lightblue", color="black", alpha=0.7)+
  geom_density(color = "red", size = 1) +
  theme_minimal()+
  labs(title="Histogramme de la magnitude 
       des éruptions fortes (>=3) ",
       x="Magnitude",
       y="")+
  theme(plot.title = element_text(hjust = 0.5, face="bold", size=16))
```
```{r}
p5 <- ggplot(df_faible,aes(x=Magnitude))+
  geom_histogram(binwidth = 0.2, fill="lightblue", color="black", alpha=0.7)+
  geom_density(color = "red", size = 1) +
  theme_minimal()+
  labs(title="Histogramme de la magnitude 
       des éruptions faible (<3) ",
       x="Magnitude",
       y="")+
  theme(plot.title = element_text(hjust = 0.5, face="bold", size=16))
p5+p4+plot_layout(widths = c(1,1))
```
Maintenant on regarde les histogrammes pour chacuns des modes. Les fortes magnitudes ont une distribution sysmétrique qui s'articule autour d'une valeur centrale de 4,3 tands que les faibles magnitudes suivent aussi une distribution sysméetique autour de 1,8 mais reste moins marqué et s'étale dans l'intervalle 1 à 2,2.

## Analyse univariée du type de magma

```{r}
ggplot(df,aes(x=Mag.Type))+
  geom_bar(binwidth = 0.2, fill="lightyellow", color="black", alpha=0.7)+
  theme_minimal()+
  labs(title="Répartition des types de magmas éruptés pour l'ensemble des volcans ",
       x="Type de magma",
       y="Nombre d'observation")+
  theme(plot.title = element_text(hjust = 0.5, face="bold", size=10))
```
La majorité des magmas sont basaltique (MB) avec quelques occurences andésitique (MA) et latitique (ML=un magma latitique est un magma basaltique avec une texture particulière, il n'y a pas de différence de chimie importante). La série est basic et donc faiblement différencié. En effet il n'y a quaiment pas de magma différencié rhyolique (MR). La faible présence de basalte alcalin (MBa) révelle que les magmas générés appartiennen à la série subalcaline. Enfin, il se produit un petit peu de mélande car 3 magmas on uen composition intermédiaire entre basaltique et andésitique (MB-MA).

## Analyse univariée du volume estimé

```{r}
p6 <- ggplot(df,aes(x=log(Volume)))+
  geom_histogram(binwidth = 0.2, fill="lightgreen", color="black", alpha=0.7)+
  geom_density(color = "red", linewidth= 1) +
  theme_minimal()+
  labs(title="Histogramme des volumes
       estimés de éruptions ",
       x="Volume érupté",
       y="")+
  theme(plot.title = element_text(hjust = 0.5, face="bold", size=16))
```


```{r}
p7 <- ggplot(df, aes(x="", y = Volume)) +
  geom_boxplot(outlier.shape = 16, outlier.color = "red", alpha = 0.7) +  # outliers visibles
  stat_summary(fun = mean, geom = "point", shape = 18, size = 3, color = "blue") + # moyenne
  scale_fill_viridis(discrete = TRUE, option = "D") +  # palette harmonieuse
  theme_minimal(base_size = 14) +
  scale_y_log10() +
  labs(
    title = "Distribution des volumes 
          estimés pour
    l'ensemble des volcans",
    x = "",
    y = "Volume"
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1),  # rotation labels si nécessaire
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(size = 12))
p7+p6+plot_layout(widths = c(1,2.5))
```
Pour les volumes estimés, on montrent également une répartition bimodale tres similaire à celle des magnitudes avec une valeur intermétidaiure entre les faibles et les forts volumes de 16,25 km3. Les forts volumes s'articulent autour d'un mode de 18,7 km3 et la faibles volume autoure de 12,5 km3 mais clea reste moins symétirque et forme plus un plateau. Les volumes estimés sont utilisés pour déterminer la magnitude de l'érution, il est donc logique qu'il suivent excatement la meme distibution pour l'hitogramme et le boxplot.

## Analyse univariée du VEI estimé

```{r}
ggplot(df,aes(x=VEI.approximatif))+
  geom_bar(binwidth = 0.2, fill="lightyellow", color="black", alpha=0.7)+
  theme_minimal()+
  labs(title="Répartition des VEI pour l'ensemble des volcans ",
       x="VEI",
       y="Nombre d'observation")+
  theme(plot.title = element_text(hjust = 0.5, face="bold", size=10))
```
Le VEI est une échelle de 1 à 8 donnant l'intensité d'une éruption volcanique (1 tres peu intense et 8 extremement intense). Dans la région, la majorité des éruptions sont de faible intensité avec un VEI autour de 1 et 2 (plus de 30 cas), VEI 1 étant majoritaire. On enregistre des éruption peu à moyennement intense (3 à 4), mais elles restent minoritaire. Il n'y a aucune éruption avec un VEI supérieure à 4, ce qui est rassurant puisque les grosses éruptions ont une occurences de plusieurs centaines d'année et sont donc difficilement visible sur une période de 10 ans.

# Analyse bivariés

Cette analyse univarié a permis de déterminer l'allure de chacune des variables du jeu données. Il est a présent possible d'étudier des liens possibles entre ces différentes données.

## Lien entre deux variables quantitatives

### Lien entre la magnitude et la profondeur 
```{r}

ggplot(df) +  geom_point(aes(x = Magnitude, y = Depth), size = 1) +
  labs(
    title = "Distribution de la magnitude des volcans en fonction de la profondeur du magma",
    x = "Magnitude",
    y = "Profondeur (km)"
  ) +
  theme_minimal ()


```
Lorsque qur l'on regarde le graphique de la profondeur en fonction de la magnitude, cinq outlier sont visble ce qui confirme nos obeservation faites dans l'univariée avec des points de profondeur beaucoup trop importante.
La deuxeme remaque est qu'il n'y a aucune corélation visible entre la profondeur et la magnétude.
Nous allons quand même effectuer un test pour vérifeir notre hypothèse. Il n'est pas possible de faire une ANOVA car nous avons de variables quantitatives et l'ANOVA compare deux moyennes de deux goupres, hors ici nous cherchons à corréler deux varables. Nous effectuons donc un test de corrélagtion.

```{r}
hist(df$Depth)
hist(df$Magnitude)
cor(df$Magnitude, df$Depth, method = "spearman")#pas de corrélation entre les deux variables 
```

On choist un test de corrélation de Spearman car les données ne sont pas distribuées normalement (voir histogramme). Il s'agit d'un test qui est dit non paramétrique. Ce ne sont pas les données en tant que telle qui sont utilisées mais leurs rangs.

Le coefficient de corrélation est de 0.32. C'est une corrélation positive mais la valuer reste faible car comprise entre 0.1 et 0.3 à plus ou moins 0.02, on a donc une faible corrélation entre la profondeur et la magnitude.

### Lien entre magnitude et le volume estimé


```{r}

ggplot(df) +  geom_point(aes(x = Magnitude, y = log(Volume)), size = 1) +
  labs(
    title = "Distribution des volumes estimés des volcans en fonction de la magnitude",
    x = "Magnitude",
    y = "Volume"
  ) +
  theme_minimal ()
res <- lm(log(Volume)~Magnitude,data=df)
summary(res)
check_model(res)
```

Graphiquement, on observe une corrélation positive entre la magnitude et le volume estimé. En effet, plus la magnitude est importante plus le volume estimé l'est également. Le modèle linéaire confirme cette observation avec un R2 de 1 ce qui est très élevé. Cependant, il existe une realtion théorique entre volume estimé et magnitude. La magnitude est calculer à parit du volume estimée sur le terrain. Ils sont donc mathéatiquement reléi l'un à l'autre et cette correlétion poistive ne reflete en rien un lien naturel entre les deux varibale mais traduits une simple équation mathématiques.

### Lien entre le volume et la profondeur 

Une relation peut également être étudiée entre le volume estimé et la profondeur. Cependant, étant donné que le volume a été estimé à partir de la magnitude, les deux graphiques montrent exactement les mêmes tendances. Cette similitude se remarque également au niveau de la valeur du coefficient de corrélation de Spearman qui vaut 0.32.
```{r}
ggplot(df) +  geom_point(aes(x = log(Volume), y = Depth), size = 1) +
  labs(
    title = "Evolution de la profondeur en fonction du volume estimé des volcans",
    x = "Log(Volume)",
    y = "Profondeur"
  ) +
  theme_minimal ()
```
 

```{r}
cor(log(df$Volume), df$Depth, method = "spearman")
```
Il 

## Lien entre variable qualitative et quantitative

### Magnitude en fonction des volcans


```{r}
p1 <- ggplot(df, aes(x = Volcanoes, y = Magnitude, color = Volcanoes)) +
  geom_boxplot(alpha = 0, width = 0.4, outlier.shape = NA) +
  stat_summary(fun = mean, geom = "point", shape = 21, size = 4, fill = "black") +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 25, hjust = 1),
    plot.title = element_text(face = "bold")
  ) +
  ggtitle("Boxplot")


p2 <- ggplot(df, aes(x = Volcanoes, y = Magnitude, color = Volcanoes)) +
  geom_jitter(position = position_jitter(width = 0.15, height = 0), alpha = 0.7, size = 2) +
  stat_summary(fun.data = mean_cl_normal, geom = "pointrange", size = 1) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 25, hjust = 1),
    plot.title = element_text(face = "bold")
  ) +
  ggtitle("Dot")


p3 <- ggplot(df, aes(x = Magnitude, fill = Volcanoes)) +
  geom_density(alpha = 0.4, color = "black", linewidth = 0.3) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    plot.title = element_text(face = "bold")
  ) +
  ggtitle("Density")


plot_grid(p1, p2, p3, nrow = 1, rel_widths = c(1, 1, 1.1))
```

On remarque à nouveau que pour le Vésuve, on ne peut interpréter car on a qu'une seule varleur.
Plusieurs remarques sont possibles. Tout d'abords, les magnitudes par volcans sont dépendantes, sinon l'ensebles des médiane serait alignées. 

De plus, la médiane et la moyenne ne coincident pas, ce qui témoignent d'une asymétries au niveau des distributions. 
Dans certains cas, les courbes de densité montrent également des bimodalités visibles. 

Il est possible d'observer que certains groupes ont des distributions bimodal et non pas juste normal. 

Si on veut observer une différence entre les volcans par rapport à la magnitude, on effectuer un test non-paramétrique. Un ANOVA ne fonctionnerait pas ici car nous n'avons une répartition normale de nos donnée de magnitude.

Il serait intéressant de savoir si il y a bien une différence significative entre ces différents volcans par rapport à la magnitude. Pour cela, le t.test ne fonctionne car celui-ci est pour des échantillons avec deux catégories dans cette étude, il y a six volcans différents. C'est donc une ANOVA qui va être réalisée. 

L'ANOVA (Analysis of Variance) permet de comparer les moyennes de plusieurs groupes pour déterminer s'il existe des différences significatives entre elles. Cependant, pour que les résultats de l'ANOVA soient valides, certaines conditions doivent être remplies :
1. Indépendance des observations : Les données de chaque groupe doivent être indépendantes les unes des autres. 
2. Normalité : La distribution des résidus (différences entre les valeurs observées et les valeurs prédites) doit suivre une distribution normale.
3. Homogénéité des variances : Les variances des différents groupes doivent être similaires (homoscédasticité).


```{r}
aov1 <- aov(Magnitude ~ Volcanoes, data = df)
opar <- par(mfrow = c(2, 2))
plot(aov1)
par(opar)
```



```{r}
leveneTest(Magnitude ~ Volcanoes, data = df)#pas significatif donc cela veut dire que les variances ne sont pas hétéroscédastique, ce qui est étrange au vu du graphique précédent. Les résidus dévient également légèrement de la normalité
```

```{r}
summary (aov1)
```
Le summary de l'ANOVA, donne une valeur de p-value de 0.264. Celle-ci n'est pas significative (p-value > 0.05), il n'y a donc pas de différence significative entre les volcans et les magnitudes. 


### Magnitude en fonction du type de magma

Le lien entre la magnitude et le type de magma peut également être étudié. 
==> Pour MBa et MR, il n'y a qu'une seule valeur de magnitude
==> Ma présente les magnitudes les plus élevées
==> MB, MB-MA, ML ont des magnitudes plus et similaire entre elles

Au niveau du graphique de densité, il est possible de voir que : 
 ==> MA présente une distribution qui est binomiale mais la plupart de l'information se trouve quand même entre 4 et 5 au niveau des magnitudes
 
==> MBa,MB,ML la distribution est bi-nomiale


```{r}
p1 <- ggplot(df, aes(x = Mag.Type, y = Magnitude, color = Mag.Type)) +
  geom_boxplot(alpha = 0, width = 0.4, outlier.shape = NA) +
  stat_summary(fun = mean, geom = "point", shape = 16, size = 4, fill = "black") +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 25, hjust = 1),
    plot.title = element_text(face = "bold")
  ) +
  ggtitle("Boxplot")


p2 <- ggplot(df, aes(x = Mag.Type, y = Magnitude, color = Mag.Type)) +
  geom_jitter(position = position_jitter(width = 0.15, height = 0), alpha = 0.7, size = 2) +
  stat_summary(fun.data = mean_cl_normal, geom = "pointrange", size = 1) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 25, hjust = 1),
    plot.title = element_text(face = "bold")
  ) +
  ggtitle("Dot")


p3 <- ggplot(df, aes(x = Magnitude, fill = Mag.Type)) +
  geom_density(alpha = 0.4, color = "black", linewidth = 0.3) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    plot.title = element_text(face = "bold")
  ) +
  ggtitle("Density")


plot_grid(p1, p2, p3, nrow = 1, rel_widths = c(1, 1, 1.1))
```

L'ANOVA doit ainsi respecter différents critères. Dans ce cas-ci : 
  L'homoscédadasticité est respectée, il est possible de voir que la ligne rouge sur le graphique est presque à l'horizontale 
  La normalité des résidus est globalement respectée. Cependant, certaines valeurs sont fortement éloignées de la droite centrale comme le 20 et le 42. 
  Au niveau du quatrième graphique, l'ensemble des donnée située dans les bornes de la distance cook. Cependant, les valeurs 20, 40 et 42 sont tout de même proche de ces extrémités. Cela peut causer un effet de levier. 
```{r}
anova_magma <- aov(Magnitude ~ Mag.Type, data = df)
opar <- par(mfrow = c(2, 2))
plot(anova_magma)
par(opar)
leveneTest(Magnitude ~ Mag.Type, data = df)
#présence d'outlier au niveau de la normalité des résidus sinon au niveau des autres graphiques cela semble respecté les conditions de l'anova sont respectée

```
L'ANOVA est ainsi réalisée, et celle-ci donne une valeur significative (p-valeur<0.05). Il y a ainsi une différences entre les différents types de magmas au niveau de la magnitude. 


```{r}
summary (anova_magma)#significatif donc il y a bien une différence entre les moyennes des magnitudes des différents types de magma
```

### Profondeur en fonction des volcans


```{r}
p1 <- ggplot(df, aes(x = Classification, y = Depth, color = Classification)) +
  geom_boxplot(alpha = 0, width = 0.4, outlier.shape = NA) +
  stat_summary(fun = mean, geom = "point", shape = 16, size = 4, fill = "black") +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 25, hjust = 1),
    plot.title = element_text(face = "bold")
  ) +
  ggtitle("Boxplot")


p2 <- ggplot(df, aes(x = Classification, y = Depth, color = Classification)) +
  geom_jitter(position = position_jitter(width = 0.15, height = 0), alpha = 0.7, size = 2) +
  stat_summary(fun.data = mean_cl_normal, geom = "pointrange", size = 1) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 25, hjust = 1),
    plot.title = element_text(face = "bold")
  ) +
  ggtitle("Dot")


p3 <- ggplot(df, aes(x = Depth, fill = Classification)) +
  geom_density(alpha = 0.4, color = "black", linewidth = 0.3) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    plot.title = element_text(face = "bold")
  ) +
  ggtitle("Density")


plot_grid(p1, p2, p3, nrow = 1, rel_widths = c(1, 1, 1.1))
```
Graphiquement, au niveau des boxplots il n'est pas possible d'observer une différence entre les différents types de magma 
```{r}
anova_clas <- aov(Depth ~ Classification, data = df)
opar <- par(mfrow = c(2, 2))
plot(anova_clas)
par(opar)
leveneTest(Depth~ Classification, data = df)

```
Les conditions de l'anova ne sont pas respectées, les résidus ne sont pas normalement distribués. Certaines des valerus atteignes presque la Cook distance. 
Il n'est ainsi pas possible de réaliser l'anova mais il est possible de réaliser un autre test qui lui est non paramétriques. Il s'agit du test Kruskall-walis 
```{r}
kruskal.test(Depth ~ Classification, data = df)
```
Le test de kruskal-wallis est signifcatif. Il faut préciser est sensible au différence de distributions donc si celles-ci sont fortement différentes comme c'est le cas ici il est possible qu'il n'y est pas uniquement une différence au niveau des médianes. 


### Profondeur en fonction du type de magma (à retirer)
```{r}
p1 <- ggplot(df, aes(x = Mag.Type, y = Depth, color = Mag.Type)) +
  geom_boxplot(alpha = 0, width = 0.4, outlier.shape = NA) +
  stat_summary(fun = mean, geom = "point", shape = 16, size = 4, fill = "black") +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 25, hjust = 1),
    plot.title = element_text(face = "bold")
  ) +
  ggtitle("Boxplot")


p2 <- ggplot(df, aes(x = Mag.Type, y = Depth, color = Mag.Type)) +
  geom_jitter(position = position_jitter(width = 0.15, height = 0), alpha = 0.7, size = 2) +
  stat_summary(fun.data = mean_cl_normal, geom = "pointrange", size = 1) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 25, hjust = 1),
    plot.title = element_text(face = "bold")
  ) +
  ggtitle("Dot")

p3 <- ggplot(df, aes(x = Depth, fill = Mag.Type)) +
  geom_density(alpha = 0.4, color = "black", linewidth = 0.3) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    plot.title = element_text(face = "bold")
  ) +
  ggtitle("Density")


plot_grid(p1, p2, p3, nrow = 1, rel_widths = c(1, 1, 1.1))
```

```{r}

anova_mgd <- aov(Depth ~ Mag.Type, data = df)
opar <- par(mfrow = c(2, 2))
plot(anova_mgd)
par(opar)

leveneTest(Depth ~ Mag.Type, data = df)

```
Les conditions de l'anova ne sont pas respectées, il y a la présence de quatres outliers qui jouent un role important de levier. 

```{r}
kruskal.test(Depth ~ Mag.Type, data = df)
```
le test de kruskal-wallis n'est pas significatif. Il n'y a donc pas de différence entre les profondeurs moyennes des différents types de magma.


### Volume estimé en fonction des volcans (à retirer)
```{r}

p1 <- ggplot(df, aes(x = Volcanoes, y = Volume, color = Volcanoes)) +
  geom_boxplot(alpha = 0, width = 0.4, outlier.shape = NA) +
  stat_summary(fun = mean, geom = "point", shape = 16, size = 4, fill = "black") +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 25, hjust = 1),
    plot.title = element_text(face = "bold")
  ) +
  ggtitle("Boxplot")


p2 <- ggplot(df, aes(x = Volcanoes, y = Volume, color = Volcanoes)) +
  geom_jitter(position = position_jitter(width = 0.15, height = 0), alpha = 0.7, size = 2) +
  stat_summary(fun.data = mean_cl_normal, geom = "pointrange", size = 1) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 25, hjust = 1),
    plot.title = element_text(face = "bold")
  ) +
  ggtitle("Dot")


p3 <- ggplot(df, aes(x = Volume, fill = Volcanoes)) +
  geom_density(alpha = 0.4, color = "black", linewidth = 0.3) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    plot.title = element_text(face = "bold")
  ) +
  ggtitle("Density")


plot_grid(p1, p2, p3, nrow = 1, rel_widths = c(1, 1, 1.1))
```

```{r}

anova_volu <- aov(log(Volume) ~ Volcanoes, data = df)
opar <- par(mfrow = c(2, 2))
plot(anova_volu)
par(opar)
leveneTest(log(Volume) ~ Volcanoes, data = df)
```
identique que la magnitude car directement extrapolé de ça 
```{r}
summary(anova_volu)
```
pas de différence significative entre les volumes moyens des différents volcans

## Lien entre deux variables qualitatives

Dans cette partie de cette étude, c'est le lien entre les variables qualitatives qui va être étudié. 

### Répartition du VEI en fonction des volcans

Il est interessant d'analyser si il y a un lien entre le VEI et les volcans. Pour cela, on va réaliser un graphique de répartition du VEI en fonction des volcans. Il est possible d'observer que la majorité des éruptions ont un VEI compris entre 1 et 3. Nisyros est celui qui présente le VEI le plus haut. 

Un autre point important qu'il faut soulever c'est que la plupart des volcans ont un VEI faible, entre 1 et 2 en majorité. 
```{r}
ggplot (df, aes (x=VEI.approximatif)) +geom_bar (aes(fill = Volcanoes),position = "dodge")+
  labs(
    title = "Répartition des VEI en fonction des volcans",
    x = "VEI",
    y = "Nombre d'observations"
  ) +
  theme_minimal ()

```
Un test peut être réalisé afin de savoir si il y a un lien entre le VEI et les différents types de volcans. Il s'agit d'un test de Chi2. Pour pouvoir faire cela, il faut d'abord réaliser un tableau de contingence. 

```{r}
tabVEI <- table (df$VEI.approximatif,df$Volcanoes)
chisq.test(tabVEI)

```
Il s'agit d'un khi-deux pour tester l'indépendance entre deux variables qualitatives. 
Les hépytohèses : 
H0 : il n'y a pas de relation entre le VEI et les différents volcans. 
H1 : il y a une relation entre le VEI et les différents volcans.

Dans ce cas-ci, le test du chi 2 est significatif car p-valeur > 0.05. Cela veut dire qu'il n'y a pas de relation significatif entre le VEI et les volcans 

### Répartition du type de magma en fonction des volcans

Il est possible de voir que MA et MB sont les types de magmas les plus fréquents. 
```{r}
ggplot (df, aes (x=Mag.Type)) +geom_bar (aes(fill = Volcanoes),position = "dodge")+
  labs(
    title = "Répartition des Type de magma en fonction des volcans",
    x = "Type de magma",
    y = "Nombre d'observations"
  ) +
  theme_minimal ()

```
```{r}
tab <- table(df$Volcanoes, df$Mag.Type)
tab
chisq.test(tab)
#signifcatif car p-valeur <0.05
```
### ACF
Une ACF est une analyse factorielle des correspondances. Cela  permet d'analyser la relation entre deux variables qualitatives. Il est ainsi important qu'il est la présence d'une relation entre les deux. C'est pour cela que l'AFC est réalisé à partir des variables Volcanoes et Mag.Type. 

Le but de l'AFC est de réduire la dimensionnalité des données tout en gardant l'écart d'indépendance entre les variables. 

Afin de pouvoir savoir le nombres d'axes qu'il faut retenir, un scree plot est réalisé. Celui-ci permet d'observer que ce sont bien les deux premiers axes qui contiennent toute l'information (~99%).

```{r}
res.ca <- CA(tab, graph = FALSE)

fviz_screeplot(res.ca, addlabels = TRUE)

```
Il est également intéressant de regarder quelles variables contribuents le plus à quels axes

```{r}

fviz_contrib(res.ca, choice = "row", axes = 1)
fviz_contrib(res.ca, choice = "col", axes = 1)
fviz_contrib(res.ca, choice = "row", axes = 2)
fviz_contrib(res.ca, choice = "col", axes = 2)

```

Les graphiques réalisés précédement peuvent être également vu de la façon suivante. En axe des X il y a la dimension 1 et en axe des deux la dimension deux 
```{r}
fviz_ca_biplot(
  res.ca,
  label = "all",
  repel = TRUE,
  col.row = "cos2",
  col.col = "cos2",
  gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
)


```


### Répartition du type de magma en fonction des classifications


```{r}
ggplot (df, aes (x=Classification)) +geom_bar (aes(fill = Mag.Type), position = "dodge")+
  labs(
    title = "Répartition des types de magma en fonction des classifications",
    x = "Classification",
    y = "Nombre d'observations"
  ) +
  theme_minimal ()
```
Comme pour le graphique précédent, il faut réaliser un test chi-deux pour savoir si il est pertinant ou non de faire une AFC
```{r}
tabmg <- table(df$Classification, df$Mag.Type)
chisq.test(tabmg)

```
```{r}
res.ca2 <- CA(tabmg, graph = FALSE)
```

```{r}
fviz_screeplot(res.ca2, addlabels = TRUE)
```
```{r}

fviz_contrib(res.ca2, choice = "row", axes = 1)
fviz_contrib(res.ca2, choice = "col", axes = 1)
fviz_contrib(res.ca2, choice = "row", axes = 2)
fviz_contrib(res.ca2, choice = "col", axes = 2)
```

```{r}
fviz_ca_biplot(
  res.ca2,
  label = "all",
  repel = TRUE,
  col.row = "cos2",
  col.col = "cos2",
  gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
)


```

# Analyse multivariée 
## Représentation graphiques 
### Répartition du type de magma selon le volcan et la classification



```{r}
ggplot(df, aes(x = Volcanoes, fill = Mag.Type)) +
  geom_bar(position = "dodge") +
  facet_wrap(~ Classification) +
  theme_minimal() +
  labs(
    x = "Volcan",
    y = "Nombre d’échantillons",
    fill = "Type de magma",
    title = "Répartition du type de magma selon le volcan et la classification"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Répartitio de la magnitude en fonction de la profondeur et des volcans
```{r}
ggplot(df) +  geom_point(aes(x = Magnitude, y = Depth, color = Volcanoes), size = 1.5) +
  labs(
    title = "Distribution de la magnitude des volcans en fonction de la profondeur du magma",
    x = "Magnitude",
    y = "Profondeur (km)"
  ) +
  theme_minimal ()

```

## ACM

```{r}
acm_data <- df[, c("Classification", "Mag.Type", "Volcanoes", "VEI.approximatif")]
res.mca <- MCA(acm_data, graph = FALSE)

```

```{r}
fviz_screeplot(res.mca, addlabels = TRUE)
```
```{r}
fviz_mca_var(
  res.mca,
  repel = TRUE,
  col.var = "cos2" , gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07")  # colorer les variables selon leur cos²
)
```
```{r}
fviz_contrib(res.mca, choice = "var", axes = 1)
fviz_contrib(res.mca, choice = "var", axes = 2)

```


## ACP 
Pas énormément de pertinence étant donnée qu'il n'y a que 3 variables 
```{r}
df_acp <- df[, c("Depth", "Magnitude", "Volume","Volcanoes")]
df_num <- df_acp %>%
  select(where(is.numeric))
chart.Correlation(df_num)
```




```{r}
acp_sect <- dudi.pca(df_num, scannf = FALSE, nf = ncol(df_acp))
str(acp_sect)
summary(acp_sect)#à analyser 
sum(acp_sect$eig)
barplot(acp_sect$eig, xlab="Axe", ylab="Valeur propre", names.arg = 1:acp_sect$rank) #permet d’afficher le screeplot en bâtonnet
```

```{r}
pheatmap(as.matrix(acp_sect$co^2), cluster_cols=F,color = rev (hcl.colors(50, "Greens")))#acp$co^2 = pourcentage de la variable qui est expliquée par chaque CP
```

```{r}
s.corcircle (acp_sect$co, xax = 1, yax = 2, sub="Correlation selon le plan 1-2")
```

```{r}
fviz_pca_biplot(acp_sect,
                geom.ind = "point",          # uniquement des points
                geom.ind.params = list(size = 2),  # taille fixe
                col.ind = df_acp$Volcanoes,  # couleur selon volcan
                fill.ind = df_acp$Volcanoes, # couleur intérieure (si shape 21)
                palette = "jco",             # palette qualitative
                pointshape = 21,             # cercles remplis
                alpha.ind = 1,               # opacité fixe
                col.var = "steelblue",       # vecteurs bleus
                repel = TRUE,
                legend.title = "Volcan",
                title = "ACP : Biplot avec points de taille fixe")


```
# Equation logistique multinomiale
```{r}
model <- multinom(Mag.Type ~ Magnitude , data = df)
model1 <- multinom(Mag.Type ~ Magnitude + Volume, data = df)
model2 <- multinom(Mag.Type ~ Magnitude + Volume + Depth, data = df)
```
```{r}
summary(model)
```

```{r}
summary(model1)#AIC la plus basse entre tout les modèles, cependant ce n'est tout de même pas des bons résultats 
```
Le problème est le suivant, les écarts types sont beaucoup trop petits. Le modèle va donc sur estimé les coefficients des classes qui ne sont pas du tout supperposée. Même si il y a un petit chevauchement, les classes extrêmes sont parfaitement séparés, c'est un cas de sépration quasi-complètes
```{r}
summary(model2)
```
```{r}
model <- multinom(Volcanoes~ Magnitude , data = df)
model1 <- multinom(Volcanoes~ Magnitude + Depth, data = df)
model2 <- multinom(Volcanoes~ Magnitude + Depth + Volume, data = df)
```
```{r}
summary(model)
```
```{r}
summary(model1)
```
```{r}
summary(model2)
```


# Clustering 
```{r}
df_cluster <- df[, c("Depth", "Magnitude", "Volume")]
fviz_nbclust(df_cluster, kmeans, method = "wss") +
  theme_minimal() +
  labs(title = "Méthode du coude - détermination du nombre de clusters")

```

```{r}
set.seed(42)  # pour reproductibilité

km <- kmeans(df_cluster, centers = 4, nstart = 25)
#il faut justifier pourquoi 3 ou 4 groupes avec la techniques du coude (c'est le mieux)
# Ajouter le cluster au jeu de données
df$Cluster <- as.factor(km$cluster)
```

```{r}
ggplot(df, aes(x = Magnitude, y = Depth, color = Cluster, size = Volume)) +
  geom_point(alpha = 0.8) +
  theme_minimal() +
  labs(
    title = "Clustering K-means : Volume, Profondeur et Magnitude",
    x = "Magnitude",
    y = "Profondeur"
  ) +
  scale_y_reverse()
```
```{r}
aggregate(df[, c("Volume", "Depth", "Magnitude")], by = list(df$Cluster), mean)
```


```{r}

plot_ly(df, x = ~Volume, y = ~Depth, z = ~Magnitude,
        color = ~Cluster, colors = "Set1",
        type = "scatter3d", mode = "markers") %>%
  layout(title = "Clustering 3D : Volume, Profondeur et Magnitude")

```




