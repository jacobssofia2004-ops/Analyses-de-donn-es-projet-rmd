---
title: "Projet d'analyse de données – Études sur les volcans méditerranéens"
author: |
  <em>Jacobs Sofia & Bauer Julie<br>
  Master STPE/MV – UCA<br>
  Année académique 2025-2026</em>
date: "<span style='float:right;'>25 septembre 2025</span>"
output: 
  html_document:
    toc: yes
    toc_float:  
      collapsed: false     
      smooth_scroll: true  
      position: right     
    number_sections: yes
    css: styles.css

---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = FALSE)
```

# Introduction 

Dans le monde, on compte plus de **800 millions** de personnes vivant à proximité d’un volcan dont **200 millions à moins de 30 km d’un volcan actif** (CNRS, 2025). La caractérisation de l’aléa volcanique est donc essentielle pour **la sureté des habitants** en territoires volcaniques. Cela passe notamment par la compréhension de lien divers entre un volcan et **le type de dépôts ou l’intensité éruptive** qu’il produit. Notre étude se concentre sur la région méditerranéenne, en particulier sur **deux édifices grecs** et **quatre édifices italiens**, ces deux pays étant particulièrement connues pour leurs volcanismes très actifs et notamment plusieurs éruptions historiques. Les volcans italiens sont **l’Etna (Sicile, Italie), le Vésuve (Naples, sud de l’Italie), Lipari et Vulcano (Iles Eoliennes, Sicile, Italie). Les volcans grecques sont le Santorin et le Nisyros (Iles Dodecanese, Grèce)**. Ici nous ne nous concentrerons que sur **la période 2015 à 2025**.

Nous avons **les données de magnitudes, types de magma, profondeur du magma, le VEI, la classification et le volume estimé de produits** pour chaque édifice volcanique en plus des coordonnées des éruptions pour chaque édifices.
L’objectif est de comprendre si il existe un **lien entre intensité de l’éruption (magnitude) et l’édifice volcanique** afin de déterminer quelle population s’expose à un **risque** plus important. Il sera aussi particulièrement intéressant de regarder le **lien possible entre volcans et type de magma** car le risques lié à un volcan est en partie du au type de matériaux qu’il produit. Ces résultats pourrait également nous permettre de déterminer si **les populations** d’un volcan en particulier s’exposent à un **risque accrue**. Enfin, d’un point de vus purement recherche nous allons nous intéressé au **lien entre édifice et profondeur du magma** car c’est grâce à la détection du magma en profondeur que l’on peut **anticiper une éruption**. Egalement à **la profondeur en fonction du type de magma** mais cela nous permettra, au terme d’une étude pétrologique ultérieure de prédire des **temps de remonté du magma et des durées pré-éruptifs** afin **d’alerter la population** en cas d’éruption imminente si ce lien existe.

# Analyse exploiratoire des données 

## Chargement et préparation des données

```{r}
packages <- c("dplyr", "ggplot2", "tidyr","performance","car","maps","ggspatial","sf", "prettymapr","rnaturalearth","rnaturalearthdata","viridis","see","patchwork","geosphere","reshape2","cowplot","factoextra","FactoMineR","plotly","PerformanceAnalytics","ade4","pheatmap","ggsci")

installed_packages <- rownames(installed.packages())
to_install <- packages[!(packages %in% installed_packages)]

if (length(to_install) > 0) {
  message("Installation des packages manquants : ", paste(to_install, collapse = ", "))
  install.packages(to_install)
}

invisible(lapply(packages, function(pkg) {
  library(pkg, character.only = TRUE)
  message("→ ", pkg, " chargé avec succès.")
}))

```

```{r}
df <- read.csv("DataR.csv", sep = ";")#importation des données
str(df)
#modification des types de variables 
df [,c(1,2,8,11,12,13,14)]<- lapply(df[,c(1,2,8,11,12,13,14)], as.factor)
df$Volume <- as.numeric(df$Volume)
summary(df)

var_quali <- df[,c("Depth","Magnitude")]
var_quanti <- df[,c("Volcanoes","Mag.Type", "Region","Country")]
```

```{r}
world <- ne_countries(scale = "medium", returnclass = "sf")

# Tracer la carte
ggplot(data = world) +
  geom_sf(fill = "antiquewhite") +
  geom_point(
    data = df,
    aes(x = Longitude, y = Latitude, color = Volcanoes),
    size = 2, alpha = 0.9
  ) +
  coord_sf(xlim = c(12, 30), ylim = c(35, 42), expand = FALSE) +
  theme_minimal() +
  labs(
    title = "Localisation des volcans en Italie du Sud et en Grèce",
    x = "Longitude",
    y = "Latitude",
    color = "Volcan"
  ) +
  theme(panel.background = element_rect(fill = "lightblue"),
        panel.grid = element_line(color = "white"))



```
```{r}
volcanIt <- df[15:36,]
str(volcanIt)
volcanGr <- df[c(1:13,37:47),]
str(volcanGr)
ggplot(data = world) +
  geom_sf(fill = "antiquewhite") +
  geom_point(
    data = volcanIt,
    aes(x = Longitude, y = Latitude, color = Volcanoes),
    size = 2, alpha = 0.9
  ) +
  coord_sf(xlim = c(12, 19), ylim = c(36.5, 41.5), expand = FALSE) +
  theme_minimal() +
  labs(
    title = "Localisation des volcans en Italie du Sud",
    x = "Longitude",
    y = "Latitude",
    color = "Volcan"
  ) +
  theme(panel.background = element_rect(fill = "lightblue"),
        panel.grid = element_line(color = "white"))

```

```{r}
ggplot(data = world) +
  geom_sf(fill = "antiquewhite") +
  geom_point(
    data = volcanGr,
    aes(x = Longitude, y = Latitude, color = Volcanoes),
    size = 2, alpha = 0.9
  ) +
  coord_sf(xlim = c(19, 30), ylim = c(35.5, 39), expand = FALSE) +
  theme_minimal() +
  labs(
    title = "Localisation des volcans de l'Archipelle des Dodecanese",
    x = "Longitude",
    y = "Latitude",
    color = "Volcan"
  ) +
  theme(panel.background = element_rect(fill = "lightblue"),
        panel.grid = element_line(color = "white"))
```


```{r}

centres <- df %>%
  group_by(Volcanoes) %>%
  summarise(
    Longitude = mean(Longitude, na.rm = TRUE),
    Latitude = mean(Latitude, na.rm = TRUE)
  )
dist_matrix_group <- distm(centres[, c("Longitude", "Latitude")], fun = distHaversine) / 1000
rownames(dist_matrix_group) <- centres$Volcanoes
colnames(dist_matrix_group) <- centres$Volcanoes
```
```{r}
dist_long <- melt(dist_matrix_group)
colnames(dist_long) <- c("Volcano1", "Volcano2", "Distance_km")
ggplot(dist_long, aes(x = Volcano1, y = Volcano2, fill = Distance_km)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "red") +
  geom_text(aes(label = round(Distance_km, 1)), color = "black") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Distances entre groupes de volcans (km)", fill = "Distance (km)")
```


## Calcule des paramètres de dispersions

```{r}
#permet de calculer la variance et la moyenne pour les variables 
calc_variances_by_group <- function(df, group_col = "Group", numeric_vars = NULL) {
  if (is.null(numeric_vars)) {
    numeric_vars <- names(df)[sapply(df, is.numeric)]
  }

  # 1. Calcul global
  global_var <- sapply(df[numeric_vars], var, na.rm = TRUE)
  global_mean <- sapply(df[numeric_vars], mean, na.rm = TRUE)

  global_df <- data.frame(
    Group = "Global",
    Variable = names(global_var),
    Variance = as.numeric(global_var),
    Mean = as.numeric(global_mean),
    stringsAsFactors = FALSE
  )

  # 2. Calcul par groupe
  groups <- unique(df[[group_col]])
  group_list <- lapply(groups, function(g) {
    sub_df <- df[df[[group_col]] == g, numeric_vars, drop = FALSE]
    s_var <- sapply(sub_df, var, na.rm = TRUE)
    s_mean <- sapply(sub_df, mean, na.rm = TRUE)
    data.frame(
      Group = g,
      Variable = names(s_var),
      Variance = as.numeric(s_var),
      Mean = as.numeric(s_mean),
      stringsAsFactors = FALSE
    )
  })
  group_df <- do.call(rbind, group_list)

  # 3. Combiner
  result <- rbind(global_df, group_df)
  rownames(result) <- NULL

  # 4. Supprimer la notation scientifique
  result$Variance <- format(result$Variance, scientific = FALSE, digits = 6)
  result$Mean <- format(result$Mean, scientific = FALSE, digits = 6)

  return(result)
}
calc_variances_by_group(df, group_col = "Volcanoes", numeric_vars = c("Depth", "Magnitude", "Volume"))


```

En moyenne, Lipari génère des magmas qui viennent de plus profond et le Santorin les plus superficiels.
Nisyros est le volcan avec le plus grand volume de produit estimé en moyenne et Vulcano emet le moins sur une même période d'activité.
La magnitude des éruptions est en moyenne plus importante pour Nisyros. Cela est cohérent car la magnitude est directement reliée au volume emis, plus le volume est important plus la magnitude le sera, hors Nisyros à le volume moyen le plus important donc la magnitude moyenne la plus importante. Cependant ce n'est pas Vulcano qui possède la plus faible moyenne des magnitudes mais l'Etna. Cela peut s'expliquer par le faite que l'Etna à plus érupter sur 2015-2025 par rapport à Vulcano pour un volume moyen de débris légèrement inférieur. La moyenne des magnitudes de l'Etna pourra donc être légèrement plus faible que celle de Vulcano.

Les valeurs de variance pour le volume et la magnitude sont ccohérentes par rapport au jeu de donné mais pour la profondeur, celles-ci sont beaucoup trop grande, cela s'explique par la présence d'outlier (7 point de donnée) de valeur beaucoup trop importante ou encore bien trop faibe qui donnent une dispersion des mesures exagérée.

On remarque qur pour le Vésuve nous n'avons qu'une seule éruption. Ainsi, nous ne pouvons pas calsuler de valeurs de dispersion et la profondeurs, la magnitude et le volume moyen seront les valeurs des données de l'éruption.
```{r}
#à quoi ça sert (je ne sais pas), pas vraiment utile 
df_quant <- df[,c("Depth","Magnitude","Volume")]
apply(df_quant,2,sd)
apply(df_quant,2,sd)/apply(df_quant,2,mean)
```
```{r}
library(dplyr)

df %>%
  group_by(Volcanoes) %>%
  summarise(
    mean_mag = mean(Magnitude, na.rm = TRUE),
    sd_mag = sd(Magnitude, na.rm = TRUE),
    min_mag = min(Magnitude, na.rm = TRUE),
    max_mag = max(Magnitude, na.rm = TRUE),
    median_mag = median(Magnitude, na.rm = TRUE)
  )

```
Les volcans grecs porduisent une plus large d'éruption de magnitudes différentes que les volacans Italiens et se sont égalment eux qui produisent les éruptions les plus intenses avec Lipari. Cependant, il n'y pas de grande difference entre les différents paramètres de dispersion des les volcans.

# Graphiques des analyses univariés



## Analyse univariée de la profondeur
```{r}

p<- ggplot(df, aes(x = "", y = Depth)) +
  geom_boxplot(outlier.shape = 16, outlier.color = "red", alpha = 0.7) +  # outliers visibles
  stat_summary(fun = mean, geom = "point", shape = 18, size = 3, color = "blue") + # moyenne
  scale_fill_viridis(discrete = TRUE, option = "D") +  # palette harmonieuse
  theme_minimal(base_size = 14) +
  scale_y_log10() +
  labs(
    title = "Distribution des profondeurs
    pour l'ensemble des volcans",
    x = "",
    y = "Profondeur (log(km)"
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1),  # rotation labels si nécessaire
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(size = 12)
  )
p1 <- ggplot(df,aes(x=Depth))+
  geom_histogram(binwidth = 0.2, fill="lightyellow", color="black", alpha=0.7)+
  geom_density(color = "red", size = 1) +
  theme_minimal()+
  labs(title="Histogramme de la 
       profondeur des magmas ",
       x="Depth",
       y="")+
  theme(plot.title = element_text(hjust = 0.5, face="bold", size=16))
p+p1+plot_layout(widths = c(1,2.25))
```
Pour l'ensemble des volcans, hormis les 7 outliers visibles en rouge sur le boxplot, la répartition des rpofondeurs sur l'hitogramme est symétique par rapport à une valeur centrale de 10 km. La majorité de nos magmas proviennet donc de chambre localsiée entre 15 et 7 km ce qui reste relativement superficielle.

## Analyse univariée de la magnitude
```{r}
p2<- ggplot(df,aes(x=Magnitude))+
  geom_histogram(binwidth = 0.2, fill="lightgreen", color="black", alpha=0.7)+
  geom_density(color = "red", size = 1) +
  theme_minimal()+
  labs(title="Histogramme de la
       magnitude de éruptions ",
       x="Magnitude",
       y="")+
  theme(plot.title = element_text(hjust = 0.5, face="bold", size=16))
```

```{r}
#séparer les deux populations que l'on observe dans le graphique précédent 
df_forte  <- df[df$Magnitude >= 3, ]
df_faible <- df[df$Magnitude < 3, ] # population forte
```

```{r}
p3 <- ggplot(df, aes(x = "", y = Magnitude)) +
  geom_boxplot(outlier.shape = 16, outlier.color = "red", alpha = 0.7) +  # outliers visibles
  stat_summary(fun = mean, geom = "point", shape = 18, size = 3, color = "blue") + # moyenne
  scale_fill_viridis(discrete = TRUE, option = "D") +  # palette harmonieuse
  theme_minimal(base_size = 14) +
  scale_y_log10() +
  labs(
    title = "Distribution des magnitudes 
    pour l'ensemble des volcans",
    x = "",
    y = "Magnitude"
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1),  # rotation labels si nécessaire
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(size = 12))

p3+p2+plot_layout(widths = c(1,1.5))
```
Le boxplot ne montre pas de valeur abérente. Cependant, l'histogramme des magnitudes montre une réputation bimodale des données. Une première partie des magnitudes se situe en dessous de 3, ce sont les valeurs de magnétudes faibles et une seconde partie se trouve au-dessus de 3 avec des valeurs dites fortes.

```{r}
 p4 <- ggplot(df_forte,aes(x=Magnitude))+
  geom_histogram(binwidth = 0.2, fill="lightblue", color="black", alpha=0.7)+
  geom_density(color = "red", size = 1) +
  theme_minimal()+
  labs(title="Histogramme de la magnitude 
       des éruptions fortes (>=3) ",
       x="Magnitude",
       y="")+
  theme(plot.title = element_text(hjust = 0.5, face="bold", size=16))
```
```{r}
p5 <- ggplot(df_faible,aes(x=Magnitude))+
  geom_histogram(binwidth = 0.2, fill="lightblue", color="black", alpha=0.7)+
  geom_density(color = "red", size = 1) +
  theme_minimal()+
  labs(title="Histogramme de la magnitude 
       des éruptions faible (<3) ",
       x="Magnitude",
       y="")+
  theme(plot.title = element_text(hjust = 0.5, face="bold", size=16))
p5+p4+plot_layout(widths = c(1,1))
```
Maintenant on regarde les histogrammes pour chacuns des modes. Les fortes magnitudes ont une distribution sysmétrique qui s'articule autour d'une valeur centrale de 4,3 tands que les faibles magnitudes suivent aussi une distribution sysméetique autour de 1,8 mais reste moins marqué et s'étale dans l'intervalle 1 à 2,2.

## Analyse univariée du type de magma

```{r}
ggplot(df,aes(x=Mag.Type))+
  geom_bar(binwidth = 0.2, fill="lightyellow", color="black", alpha=0.7)+
  theme_minimal()+
  labs(title="Répartition des types de magmas éruptés pour l'ensemble des volcans ",
       x="Type de magma",
       y="Nombre d'observation")+
  theme(plot.title = element_text(hjust = 0.5, face="bold", size=10))
```
La majorité des magmas sont basaltique (MB) avec quelques occurences andésitique (MA) et latitique (ML=un magma latitique est un magma basaltique avec une texture particulière, il n'y a pas de différence de chimie importante). La série est basic et donc faiblement différencié. En effet il n'y a quaiment pas de magma différencié rhyolique (MR). La faible présence de basalte alcalin (MBa) révelle que les magmas générés appartiennen à la série subalcaline. Enfin, il se produit un petit peu de mélande car 3 magmas on uen composition intermédiaire entre basaltique et andésitique (MB-MA).

## Analyse univariée du volume estimé

```{r}
p6 <- ggplot(df,aes(x=log(Volume)))+
  geom_histogram(binwidth = 0.2, fill="lightgreen", color="black", alpha=0.7)+
  geom_density(color = "red", linewidth= 1) +
  theme_minimal()+
  labs(title="Histogramme des volumes
       estimés de éruptions ",
       x="Volume érupté",
       y="")+
  theme(plot.title = element_text(hjust = 0.5, face="bold", size=16))
```


```{r}
p7 <- ggplot(df, aes(x="", y = Volume)) +
  geom_boxplot(outlier.shape = 16, outlier.color = "red", alpha = 0.7) +  # outliers visibles
  stat_summary(fun = mean, geom = "point", shape = 18, size = 3, color = "blue") + # moyenne
  scale_fill_viridis(discrete = TRUE, option = "D") +  # palette harmonieuse
  theme_minimal(base_size = 14) +
  scale_y_log10() +
  labs(
    title = "Distribution des volumes 
          estimés pour
    l'ensemble des volcans",
    x = "",
    y = "Volume"
  ) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1),  # rotation labels si nécessaire
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(size = 12))
p7+p6+plot_layout(widths = c(1,2.5))
```
Pour les volumes estimés, on montrent également une répartition bimodale tres similaire à celle des magnitudes avec une valeur intermétidaiure entre les faibles et les forts volumes de 16,25 km3. Les forts volumes s'articulent autour d'un mode de 18,7 km3 et la faibles volume autoure de 12,5 km3 mais clea reste moins symétirque et forme plus un plateau. Les volumes estimés sont utilisés pour déterminer la magnitude de l'érution, il est donc logique qu'il suivent excatement la meme distibution pour l'hitogramme et le boxplot.

## Analyse univariée du VEI estimé

```{r}
ggplot(df,aes(x=VEI.approximatif))+
  geom_bar(binwidth = 0.2, fill="lightyellow", color="black", alpha=0.7)+
  theme_minimal()+
  labs(title="Répartition des VEI pour l'ensemble des volcans ",
       x="VEI",
       y="Nombre d'observation")+
  theme(plot.title = element_text(hjust = 0.5, face="bold", size=10))
```
Le VEI est une échelle de 1 à 8 donnant l'intensité d'une éruption volcanique (1 tres peu intense et 8 extremement intense). Dans la région, la majorité des éruptions sont de faible intensité avec un VEI autour de 1 et 2 (plus de 30 cas), VEI 1 étant majoritaire. On enregistre des éruption peu à moyennement intense (3 à 4), mais elles restent minoritaire. Il n'y a aucune éruption avec un VEI supérieure à 4, ce qui est rassurant puisque les grosses éruptions ont une occurences de plusieurs centaines d'année et sont donc difficilement visible sur une période de 10 ans.

# Analyse bivariés

Cette analyse univarié a permis de déterminer l'allure de chacune des variables du jeu données. Il est a présent possible d'étudier des liens possibles entre ces différentes données. Tout d'abord, 

Lien entre la magnitude et la profondeur 
```{r}

ggplot(df) +  geom_point(aes(x = Magnitude, y = Depth), size = 1) +
  labs(
    title = "Distribution de la magnitude des volcans en fonction de la profondeur du magma",
    x = "Magnitude",
    y = "Profondeur (km)"
  ) +
  theme_minimal ()


```




```{r}
anova_result <- aov(Depth ~ Magnitude, data = df)
hist(anova_result$residuals)#les résidus ne sont pas distribué de manière normal


```
normalement peut pas utiliser l'anova donc il faut utiliser un autre  test comme kruskal-wallis

```{r}
#faire une anova avant de faire un test non paramétrique 
kruskal.test(Depth ~ Volcanoes, data = df)
kruskal.test(Depth ~ Magnitude, data = df)

#ces deux test sont des test non paramétriques. Ils ne dépendent pas d'hypothèse sur la distribution des résidues, ni sur des paramètres particuliers comme la moyenne ou la variance. Ceux-ci sont basés sur des rangs.
#Le test de Kruskal-Wallis est utilisé pour déterminer s'il existe des différences significatives entre les médianes de plusieurs groupes indépendants.
#dans ce cas-ci il n'y a pas de différence significative entre les groupes de volcans et de magnitude en ce qui concerne la profondeur du magma.
```


lien entre magnitude et le volume estimé 
```{r}

ggplot(df) +  geom_point(aes(x = Magnitude, y = log(Volume)), size = 1) +
  labs(
    title = "Distribution des volumes estimés des volcans en fonction de la magnitude",
    x = "Magnitude",
    y = "Volume"
  ) +
  theme_minimal ()
res <- lm(log(Volume)~Magnitude,data=df)
summary(res)
check_model(res)
```


pas possible de faire une interprétation car R2 = 1 car directement calculé par rapport à la magnitude. C'est pour cela que la relation VEI et magnitude n'est pas pertinente car celle-ci est également tiré de la magnitude


Lien entre le volume et la profondeur 
```{r}
ggplot(df) +  geom_point(aes(x = log(Volume), y = Depth), size = 1) +
  labs(
    title = "Evolution de la profondeur en fonction du volume estimé des volcans",
    x = "Log(Volume)",
    y = "Profondeur"
  ) +
  theme_minimal ()
```


```{r}
anova_result <- aov(Depth ~ log(Volume), data = df)
hist(anova_result$residuals)
```
Pas d'anova car les résidus ne sont pas distribués normalement. Utilisation du test de kruskal-wallis

 
```{r}
var.test(df_faible$Magnitude, df_forte$Magnitude)#OK
t.test (df_faible$Magnitude, df_forte$Magnitude, var.equal = TRUE)

```

Magnitude en fonction des volcans puis Magnitude en fonction du type de magma.
```{r}
p1 <- ggplot(df, aes(x = Volcanoes, y = Magnitude, color = Volcanoes)) +
  geom_boxplot(alpha = 0, width = 0.4, outlier.shape = NA) +
  stat_summary(fun = mean, geom = "point", shape = 21, size = 4, fill = "black") +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 25, hjust = 1),
    plot.title = element_text(face = "bold")
  ) +
  ggtitle("Boxplot")


p2 <- ggplot(df, aes(x = Volcanoes, y = Magnitude, color = Volcanoes)) +
  geom_jitter(position = position_jitter(width = 0.15, height = 0), alpha = 0.7, size = 2) +
  stat_summary(fun.data = mean_cl_normal, geom = "pointrange", size = 1) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 25, hjust = 1),
    plot.title = element_text(face = "bold")
  ) +
  ggtitle("Dot")


p3 <- ggplot(df, aes(x = Magnitude, fill = Volcanoes)) +
  geom_density(alpha = 0.4, color = "black", linewidth = 0.3) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    plot.title = element_text(face = "bold")
  ) +
  ggtitle("Density")


plot_grid(p1, p2, p3, nrow = 1, rel_widths = c(1, 1, 1.1))
```

Possible d'observer que certains groupes ont des distributions bimodal et non pas juste normal 

```{r}
anova_result <- aov(Magnitude ~ Volcanoes, data = df)
summary(anova_result)
```
pas de différence significative entre les magnitudes moyennes des différents volcans

```{r}
p1 <- ggplot(df, aes(x = Mag.Type, y = Magnitude, color = Mag.Type)) +
  geom_boxplot(alpha = 0, width = 0.4, outlier.shape = NA) +
  stat_summary(fun = mean, geom = "point", shape = 16, size = 4, fill = "black") +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 25, hjust = 1),
    plot.title = element_text(face = "bold")
  ) +
  ggtitle("Boxplot")


p2 <- ggplot(df, aes(x = Mag.Type, y = Magnitude, color = Mag.Type)) +
  geom_jitter(position = position_jitter(width = 0.15, height = 0), alpha = 0.7, size = 2) +
  stat_summary(fun.data = mean_cl_normal, geom = "pointrange", size = 1) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 25, hjust = 1),
    plot.title = element_text(face = "bold")
  ) +
  ggtitle("Dot")


p3 <- ggplot(df, aes(x = Magnitude, fill = Mag.Type)) +
  geom_density(alpha = 0.4, color = "black", linewidth = 0.3) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    plot.title = element_text(face = "bold")
  ) +
  ggtitle("Density")


plot_grid(p1, p2, p3, nrow = 1, rel_widths = c(1, 1, 1.1))
```
il n'y a pas une distribution normale de la donnée. Certains des types de magmas ne présentent qu'une seul variable. 

```{r}

leveneTest(Magnitude ~ Mag.Type, data = df)
anova_magma <- aov(Magnitude ~ Mag.Type, data = df)
hist(anova_magma$residuals)
summary(anova_magma)
#TukeyHSD(anova_magma)


```


```{r}
p1 <- ggplot(df, aes(x = Classification, y = Depth, color = Classification)) +
  geom_boxplot(alpha = 0, width = 0.4, outlier.shape = NA) +
  stat_summary(fun = mean, geom = "point", shape = 16, size = 4, fill = "black") +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 25, hjust = 1),
    plot.title = element_text(face = "bold")
  ) +
  ggtitle("Boxplot")


p2 <- ggplot(df, aes(x = Classification, y = Depth, color = Classification)) +
  geom_jitter(position = position_jitter(width = 0.15, height = 0), alpha = 0.7, size = 2) +
  stat_summary(fun.data = mean_cl_normal, geom = "pointrange", size = 1) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 25, hjust = 1),
    plot.title = element_text(face = "bold")
  ) +
  ggtitle("Dot")


p3 <- ggplot(df, aes(x = Depth, fill = Classification)) +
  geom_density(alpha = 0.4, color = "black", linewidth = 0.3) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    plot.title = element_text(face = "bold")
  ) +
  ggtitle("Density")


plot_grid(p1, p2, p3, nrow = 1, rel_widths = c(1, 1, 1.1))
```
```{r}
p1 <- ggplot(df, aes(x = Mag.Type, y = Depth, color = Mag.Type)) +
  geom_boxplot(alpha = 0, width = 0.4, outlier.shape = NA) +
  stat_summary(fun = mean, geom = "point", shape = 16, size = 4, fill = "black") +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 25, hjust = 1),
    plot.title = element_text(face = "bold")
  ) +
  ggtitle("Boxplot")


p2 <- ggplot(df, aes(x = Mag.Type, y = Depth, color = Mag.Type)) +
  geom_jitter(position = position_jitter(width = 0.15, height = 0), alpha = 0.7, size = 2) +
  stat_summary(fun.data = mean_cl_normal, geom = "pointrange", size = 1) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 25, hjust = 1),
    plot.title = element_text(face = "bold")
  ) +
  ggtitle("Dot")

p3 <- ggplot(df, aes(x = Depth, fill = Mag.Type)) +
  geom_density(alpha = 0.4, color = "black", linewidth = 0.3) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    plot.title = element_text(face = "bold")
  ) +
  ggtitle("Density")


plot_grid(p1, p2, p3, nrow = 1, rel_widths = c(1, 1, 1.1))
```

```{r}
leveneTest(Depth ~ Mag.Type, data = df)
anova_magma1 <- aov(Depth ~ Mag.Type, data = df)
hist(anova_magma1$residuals)
summary(anova_magma1)
```


```{r}

p1 <- ggplot(df, aes(x = Volcanoes, y = Volume, color = Volcanoes)) +
  geom_boxplot(alpha = 0, width = 0.4, outlier.shape = NA) +
  stat_summary(fun = mean, geom = "point", shape = 16, size = 4, fill = "black") +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 25, hjust = 1),
    plot.title = element_text(face = "bold")
  ) +
  ggtitle("Boxplot")


p2 <- ggplot(df, aes(x = Volcanoes, y = Volume, color = Volcanoes)) +
  geom_jitter(position = position_jitter(width = 0.15, height = 0), alpha = 0.7, size = 2) +
  stat_summary(fun.data = mean_cl_normal, geom = "pointrange", size = 1) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 25, hjust = 1),
    plot.title = element_text(face = "bold")
  ) +
  ggtitle("Dot")


p3 <- ggplot(df, aes(x = Volume, fill = Volcanoes)) +
  geom_density(alpha = 0.4, color = "black", linewidth = 0.3) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "none",
    plot.title = element_text(face = "bold")
  ) +
  ggtitle("Density")


plot_grid(p1, p2, p3, nrow = 1, rel_widths = c(1, 1, 1.1))
```

```{r}
leveneTest(log(Volume) ~ Volcanoes, data = df)
anova_magma2 <- aov(log(Volume) ~ Volcanoes, data = df)
hist(anova_magma2$residuals)
summary(anova_magma2)
```


graphique : VEI + volcanoes 
```{r}
ggplot (df, aes (x=VEI.approximatif)) +geom_bar (aes(fill = Volcanoes),position = "dodge")+
  labs(
    title = "Répartition des VEI en fonction des volcans",
    x = "VEI",
    y = "Nombre d'observations"
  ) +
  theme_minimal ()

```

```{r}
ggplot (df, aes (x=Mag.Type)) +geom_bar (aes(fill = Volcanoes),position = "dodge")+
  labs(
    title = "Répartition des Type de magma en fonction des volcans",
    x = "VEI",
    y = "Nombre d'observations"
  ) +
  theme_minimal ()

```
```{r}
ggplot (df, aes (x=Classification)) +geom_bar (aes(fill = Volcanoes),position = "dodge")+
  labs(
    title = "Répartition des classifications en fonction des volcans",
    x = "Classification",
    y = "Nombre d'observations"
  ) +
  theme_minimal ()
```

```{r}
ggplot (df, aes (x=Classification)) +geom_bar (aes(fill = Mag.Type), position = "dodge")+
  labs(
    title = "Répartition des types de magma en fonction des classifications",
    x = "Classification",
    y = "Nombre d'observations"
  ) +
  theme_minimal ()
```

# Analyse multivariée 

```{r}
ggplot(df, aes(x = Volcanoes, fill = Mag.Type)) +
  geom_bar(position = "dodge") +
  facet_wrap(~ Classification) +
  theme_minimal() +
  labs(
    x = "Volcan",
    y = "Nombre d’échantillons",
    fill = "Type de magma",
    title = "Répartition du type de magma selon le volcan et la classification"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
```{r}
ggplot(df) +  geom_point(aes(x = Magnitude, y = Depth, color = Volcanoes), size = 1.5) +
  labs(
    title = "Distribution de la magnitude des volcans en fonction de la profondeur du magma",
    x = "Magnitude",
    y = "Profondeur (km)"
  ) +
  theme_minimal ()

```

```{r}
ancova_interaction <- aov(Depth ~ Magnitude* Volcanoes, data = df)
hist(ancova_interaction$residuals)
summary(ancova_interaction)

```
```{r}
ancova_additive <- aov(Depth~ Magnitude + Volcanoes, data = df)
hist(ancova_additive$residuals)
summary(ancova_additive)

```


```{r}
tab <- table(df$Volcanoes, df$Mag.Type)
tab
test_chi2 <- chisq.test(tab)
#signifcatif car p-valeur <0.05

res.ca <- CA(tab, graph = FALSE)
fviz_ca_biplot(res.ca, repel = TRUE)
```
```{r}
tab <- table(df$Volcanoes, df$Mag.Type)
tab
test_chi2 <- chisq.test(tab)
#signifcatif car p-valeur <0.05

res.ca <- CA(tab, graph = FALSE)
fviz_ca_biplot(res.ca, repel = TRUE)
```

```{r}
tab1 <- table(df$Classification, df$Mag.Type)
test_chi2 <- chisq.test(tab1)
res.ca1 <- CA(tab1, graph = FALSE)
fviz_ca_biplot(res.ca1, repel = TRUE)
```
```{r}
tab2 <- table(df$Classification, df$Volcanoes)
tab2
test_chi2 <- chisq.test(tab2)
res.ca2 <- CA(tab2, graph = FALSE)
fviz_ca_biplot(res.ca2, repel = TRUE)
```

ACM
```{r}
acm_data <- df[, c("Classification", "Mag.Type", "Volcanoes", "VEI.approximatif")]
res.mca <- MCA(acm_data, graph = FALSE)
fviz_mca_biplot(res.mca, repel = TRUE,
                title = "Analyse des correspondances multiples (ACM)")
#au niveau des dimensions 1 et 2 pas énormément d'informations 
```
ACP 
Pas énormément de pertinence étant donnée qu'il n'y a que 3 variables 
```{r}
df_acp <- df[, c("Depth", "Magnitude", "Volume","Volcanoes")]
df_num <- df_acp %>%
  select(where(is.numeric))
chart.Correlation(df_num)
```
```{r}
acp_sect <- dudi.pca(df_num, scannf = FALSE, nf = ncol(df_acp))
str(acp_sect)
summary(acp_sect)#à analyser 
sum(acp_sect$eig)
barplot(acp_sect$eig, xlab="Axe", ylab="Valeur propre", names.arg = 1:acp_sect$rank) #permet d’afficher le screeplot en bâtonnet
```
```{r}
pheatmap(as.matrix(acp_sect$co^2), cluster_cols=F,color = rev (hcl.colors(50, "Greens")))#acp$co^2 = pourcentage de la variable qui est expliquée par chaque CP
```
```{r}
s.corcircle (acp_sect$co, xax = 1, yax = 2, sub="Correlation selon le plan 1-2")
```
```{r}
fviz_pca_biplot(acp_sect,
                geom.ind = "point",          # uniquement des points
                geom.ind.params = list(size = 2),  # taille fixe
                col.ind = df_acp$Volcanoes,  # couleur selon volcan
                fill.ind = df_acp$Volcanoes, # couleur intérieure (si shape 21)
                palette = "jco",             # palette qualitative
                pointshape = 21,             # cercles remplis
                alpha.ind = 1,               # opacité fixe
                col.var = "steelblue",       # vecteurs bleus
                repel = TRUE,
                legend.title = "Volcan",
                title = "ACP : Biplot avec points de taille fixe")


```



Clustering 
```{r}
df_cluster <- df[, c("Depth", "Magnitude", "Volume")]
fviz_nbclust(df_cluster, kmeans, method = "wss") +
  theme_minimal() +
  labs(title = "Méthode du coude - détermination du nombre de clusters")

```

```{r}
set.seed(42)  # pour reproductibilité

km <- kmeans(df_cluster, centers = 4, nstart = 25)
#il faut justifier pourquoi 3 ou 4 groupes avec la techniques du coude (c'est le mieux)
# Ajouter le cluster au jeu de données
df$Cluster <- as.factor(km$cluster)
```

```{r}
ggplot(df, aes(x = Magnitude, y = Depth, color = Cluster, size = Volume)) +
  geom_point(alpha = 0.8) +
  theme_minimal() +
  labs(
    title = "Clustering K-means : Volume, Profondeur et Magnitude",
    x = "Magnitude",
    y = "Profondeur"
  ) +
  scale_y_reverse()
```
```{r}
aggregate(df[, c("Volume", "Depth", "Magnitude")], by = list(df$Cluster), mean)
```


```{r}

plot_ly(df, x = ~Volume, y = ~Depth, z = ~Magnitude,
        color = ~Cluster, colors = "Set1",
        type = "scatter3d", mode = "markers") %>%
  layout(title = "Clustering 3D : Volume, Profondeur et Magnitude")

```


